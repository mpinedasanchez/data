name: Deploy via rsync

on:
  push:
    branches: [ main, dev ]

jobs:
  deploy_prod:
    name: Deploy to PROD (main)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${{ secrets.VPS_HOST_PROD }} >> ~/.ssh/known_hosts

      - name: Deploy with rsync
        env:
          RSYNC_SRC: "./"     # carpeta del repo
          RSYNC_DEST: "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST_PROD }}:${{ secrets.VPS_PATH_PROD }}"
        run: |
          rsync -avz --delete --exclude ".git/" --exclude ".github/" "$RSYNC_SRC" "$RSYNC_DEST"

  deploy_dev:
    name: Deploy to STAGING (dev)
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${{ secrets.VPS_HOST_DEV }} >> ~/.ssh/known_hosts

      - name: Deploy with rsync
        env:
          RSYNC_SRC: "./"    # carpeta del repo
          RSYNC_DEST: "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST_DEV }}:${{ secrets.VPS_PATH_DEV }}"
        run: |
          rsync -avz --delete --exclude ".git/" --exclude ".github/" "$RSYNC_SRC" "$RSYNC_DEST"